<?php 
session_start();
//include("../pagecomponents/indexinclude.php");
require_once('../pagecomponents/validate.php');
require_once('../pagecomponents/connectDB.php');

$passwordOld=$_POST["OldPassword"];
$passwordNew1=$_POST["NewPassword1"];
$passwordNew2=$_POST["NewPassword2"];

function randomSalt() {
    $alphabet = "abcdefghijklmnopqrstuwxyzABCDEFGHIJKLMNOPQRSTUWXYZ0123456789";
    $pass = array(); //remember to declare $pass as an array
    $alphaLength = strlen($alphabet) - 1; //put the length -1 in cache
    for ($i = 0; $i < 20; $i++) {
        $n = rand(0, $alphaLength);
        $pass[] = $alphabet[$n];
    }
    return implode($pass); //turn the array into a string
}

$newSalt = randomSalt();
//$salt = base64_encode($salt);
//$hash = crypt($password, '$2y$10$'.$salt.'$');
?>
<div class="noResults">
<?php
    if(isset($_SESSION["userID"])){
        $sql = "SELECT password, salt FROM staff_details WHERE staff_id = ".$_SESSION["userID"];
        $result=mysqli_query($con,$sql);
        while($row = mysqli_fetch_array($result)){ 
	    $hash = crypt($passwordOld, '$5$'.$row['salt'].'$');
            if($hash == $row['password']){
                $correct_pass = true;   
            }
	    else{
		$correct_pass = false;  
	    }
        }
     }else{
        echo "You are not logged in! Please <a href='http://trustinblack.com/harmonyhospital/login.php'>Login</a> first";  
    }
if($correct_pass){
        if($passwordNew1 == $passwordNew2){
	    $hash = crypt($passwordNew1, '$5$'.$newSalt.'$');
            $sql="UPDATE staff_details SET password = ". "'". $hash. "'". ", salt = ". "'". $newSalt. "'". " WHERE staff_id = ".$_SESSION["userID"];
            $result=mysqli_query($con,$sql);
            echo "You have successfully changed your password!<br />";
            echo "Go back to <a href='http://trustinblack.com/harmonyhospital/index.php'>Main Page</a>";     
        }else{
            echo "Passwords were not the same.";   
        }
}else{
    echo "The password entered was not correct.";   
}

require_once('../pagecomponents/closeConnection.php');
?>
</div>
